<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Data Science Workshop</title>
  <meta name="description" content="Lessons for the BSPR 2018 Data Science Workshop">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Data Science Workshop" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Lessons for the BSPR 2018 Data Science Workshop" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Data Science Workshop" />
  
  <meta name="twitter:description" content="Lessons for the BSPR 2018 Data Science Workshop" />
  

<meta name="author" content="Alistair Bailey">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="transform.html">
<link rel="next" href="visualising-proteomics-data.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#requirements"><i class="fa fa-check"></i>Requirements</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#what-are-r-and-rstudio"><i class="fa fa-check"></i><b>1.1</b> What are R and RStudio?</a><ul>
<li class="chapter" data-level="1.1.1" data-path="intro.html"><a href="intro.html#environments"><i class="fa fa-check"></i><b>1.1.1</b> Environments</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#why-learn-r-or-any-language"><i class="fa fa-check"></i><b>1.2</b> Why learn R, or any language ?</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#finding-your-way-around-rstudio"><i class="fa fa-check"></i><b>1.3</b> Finding your way around RStudio</a><ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#what-is-real"><i class="fa fa-check"></i><b>1.3.1</b> What is real?</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#where-am-i"><i class="fa fa-check"></i><b>1.4</b> Where am I?</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#r-projects"><i class="fa fa-check"></i><b>1.5</b> R projects</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#naming-things"><i class="fa fa-check"></i><b>1.6</b> Naming things</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#seeking-help"><i class="fa fa-check"></i><b>1.7</b> Seeking help</a><ul>
<li class="chapter" data-level="1.7.1" data-path="intro.html"><a href="intro.html#asking-for-help"><i class="fa fa-check"></i><b>1.7.1</b> Asking for help</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidyverse.html"><a href="tidyverse.html"><i class="fa fa-check"></i><b>2</b> Getting started in R and the tidyverse</a></li>
<li class="chapter" data-level="3" data-path="transform.html"><a href="transform.html"><i class="fa fa-check"></i><b>3</b> Importing and transforming proteomics data</a><ul>
<li class="chapter" data-level="3.1" data-path="transform.html"><a href="transform.html#importing-flat-files"><i class="fa fa-check"></i><b>3.1</b> Importing flat files</a></li>
<li class="chapter" data-level="3.2" data-path="transform.html"><a href="transform.html#calculating-fold-change-and-enrichment"><i class="fa fa-check"></i><b>3.2</b> Calculating fold change and enrichment</a></li>
<li class="chapter" data-level="3.3" data-path="transform.html"><a href="transform.html#fold-change-and-log-fold-change"><i class="fa fa-check"></i><b>3.3</b> Fold change and log-fold change</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="fold-change-and-t-test.html"><a href="fold-change-and-t-test.html"><i class="fa fa-check"></i><b>4</b> Fold change and t-test</a><ul>
<li class="chapter" data-level="4.1" data-path="fold-change-and-t-test.html"><a href="fold-change-and-t-test.html#heatmap-transformation"><i class="fa fa-check"></i><b>4.1</b> Heatmap transformation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="visualising-proteomics-data.html"><a href="visualising-proteomics-data.html"><i class="fa fa-check"></i><b>5</b> Visualising proteomics data</a><ul>
<li class="chapter" data-level="5.1" data-path="visualising-proteomics-data.html"><a href="visualising-proteomics-data.html#creating-a-volcano-plot"><i class="fa fa-check"></i><b>5.1</b> Creating a volcano plot</a></li>
<li class="chapter" data-level="5.2" data-path="visualising-proteomics-data.html"><a href="visualising-proteomics-data.html#creating-a-heatmap"><i class="fa fa-check"></i><b>5.2</b> Creating a heatmap</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="going-further.html"><a href="going-further.html"><i class="fa fa-check"></i><b>6</b> Going further</a><ul>
<li class="chapter" data-level="6.1" data-path="going-further.html"><a href="going-further.html#getting-help-and-joining-the-r-community"><i class="fa fa-check"></i><b>6.1</b> Getting help and joining the R community</a></li>
<li class="chapter" data-level="6.2" data-path="going-further.html"><a href="going-further.html#communication-creating-reports-presentations-and-websites"><i class="fa fa-check"></i><b>6.2</b> Communication: creating reports, presentations and websites</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Science Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="fold-change-and-t-test" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Fold change and t-test</h1>
<ol style="list-style-type: decimal">
<li><p>Load the data, we need multiple replicates for each condition. To be tidy each protein is a set of observations (rows) of the variables, which are the values recorded for each replicate (columns).</p></li>
<li><p>Tidy up and deal with missing values, either impute or exclude missing values and normalise.</p></li>
</ol>
<p>Let’s consider our proteomics data as a distribution of values, one value for each protein in our experiment that together form a distribution. If we have replicate experiments we’ll therefore have multiple distributions.</p>
<p>A quantile represents a region of distribution, for example the 0.95 quantile is the value such that 95% of the data lies below it. To normalise two or more distributions with each other without recourse to a reference distribution we:</p>
<ol style="list-style-type: lower-roman">
<li>Rank the value in each experiment (represented in the columns) from lowest to highest. In other words identify the quantiles.</li>
<li>Sort each experiment (the columns) from lowest to highest value.</li>
<li>Calculate the mean across the rows for the sorted values.</li>
<li>Then substitute these mean values back according to rank for each experiment to restore the original order.</li>
</ol>
<p>This results in the highest ranking observation in each experiment becoming the mean of the highest observations across all experiments, the second ranking observation in each experiment becoming the mean of the second highest observations across all experiments.</p>
<p><a href="https://davetang.org/muse/2014/07/07/quantile-normalisation-in-r/">Dave Tang’s Blog : Quantile Normalisation in R</a></p>
<p><a href="https://twitter.com/rafalab/status/545586012219772928?ref_src=twsrc%5Etfw">Rafael Irizarry’s tweet</a></p>

<div class="figure" style="text-align: center"><span id="fig:quant-norm"></span>
<img src="img/quant_norm.png" alt="Quantile Normalisation." width="80%" />
<p class="caption">
Figure 4.1: Quantile Normalisation.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Tidy data up</span>
dat_tidy &lt;-<span class="st"> </span>dat_em <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Remove missing values</span>
<span class="st">  </span><span class="kw">drop_na</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Select and rename columns</span>
<span class="st">  </span><span class="kw">select</span>(<span class="dt">protein_accession =</span> protein_key_protein_accession,
         protein_description,
         <span class="dt">con1 =</span> protein_ngram_on_column_emilly_bowler_wt_rep1_001_merged_spectrum_ia_final_protein,
         <span class="dt">con2 =</span> protein_ngram_on_column_emilly_bowler_wt_rep2_001_merged_spectrum_ia_final_protein,
         <span class="dt">con3 =</span> protein_ngram_on_column_emilly_bowler_wt_rep3_001_merged_spectrum_ia_final_protein,
         <span class="dt">trt1 =</span> protein_ngram_on_column_emilly_bowler_kogsk_rep1_001_merged_spectrum_ia_final_protein,
         <span class="dt">trt2 =</span> protein_ngram_on_column_emilly_bowler_kogsk_rep2_merged_ia_final_protein,
         <span class="dt">trt3 =</span> protein_ngram_on_column_emilly_bowler_kogsk_rep3_001_merged_spectrum_ia_final_protein)


<span class="co"># dat_tidy &lt;- dat_char %&gt;%</span>
<span class="co">#   # Remove missing values</span>
<span class="co">#   drop_na() %&gt;%</span>
<span class="co">#   # Select and rename columns</span>
<span class="co">#   select(protein_accession = protein_entry_protein_accession,</span>
<span class="co">#          protein_description,</span>
<span class="co">#          con1 = 9,</span>
<span class="co">#          con2 = 11,</span>
<span class="co">#          con3 = 13,</span>
<span class="co">#          trt1 = 21,</span>
<span class="co">#          trt2 = 23,</span>
<span class="co">#          trt3 = 25)</span>

<span class="co"># dat_tidy &lt;- dat_le %&gt;%</span>
<span class="co">#   # Remove missing values</span>
<span class="co">#   drop_na() %&gt;%</span>
<span class="co">#   # Select and rename columns</span>
<span class="co">#   select(protein_accession = protein_accession,</span>
<span class="co">#          protein_description,</span>
<span class="co">#          con1 = 5,</span>
<span class="co">#          con2 = 7,</span>
<span class="co">#          con3 = 11,</span>
<span class="co">#          trt1 = 3,</span>
<span class="co">#          trt2 = 9,</span>
<span class="co">#          trt3 = 13)</span>

<span class="co"># Plot data</span>
dat_tidy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(con1))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(con2), <span class="dt">colour =</span> <span class="st">&quot;blue&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(con3), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>))</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/tidy-data-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat_tidy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(trt1))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(trt2), <span class="dt">colour =</span> <span class="st">&quot;blue&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(trt3), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>))</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/tidy-data-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Normalise to maximum column value</span>
dat_norm_max &lt;-<span class="st"> </span>dat_tidy <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">wt1 =</span> con1<span class="op">/</span><span class="kw">max</span>(con1),
         <span class="dt">con2 =</span> con2<span class="op">/</span><span class="kw">max</span>(con3),
         <span class="dt">con3 =</span> con3<span class="op">/</span><span class="kw">max</span>(con3),
         <span class="dt">trt1 =</span> trt1 <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(trt1),
         <span class="dt">trt2 =</span> trt2 <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(trt2),
         <span class="dt">trt3 =</span> trt3 <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(trt3)
         )

<span class="co"># Normalise </span>
<span class="co"># dat_rank &lt;- dat_tidy %&gt;% select(-c(1:2,6:8)) %&gt;% </span>
<span class="co">#   apply(., 2, rank, ties.method=&quot;average&quot;) %&gt;% as.data.frame()</span>
<span class="co"># </span>
<span class="co"># dat_sort &lt;- dat_tidy %&gt;% select(-c(1:2,6:8)) %&gt;% </span>
<span class="co">#   apply(., 2, sort) %&gt;% as.data.frame()</span>
<span class="co"># </span>
<span class="co"># dat_mean &lt;- dat_sort %&gt;% apply(., 1, mean)</span>
<span class="co"># </span>
<span class="co"># index_mean &lt;- function(my_idx, my_mean){</span>
<span class="co">#   return(my_mean[my_idx])</span>
<span class="co"># }</span>
<span class="co"># </span>
<span class="co"># dat_norm &lt;- dat_rank %&gt;% </span>
<span class="co">#   apply(.,2,index_mean, my_mean = dat_mean) %&gt;% </span>
<span class="co">#   as.data.frame()</span>

<span class="co"># Quantile normalisation : the aim is to give different distributions the</span>
<span class="co"># same statistical properties</span>
quantile_normalisation &lt;-<span class="st"> </span><span class="cf">function</span>(df){
  <span class="co">#</span>
  df_rank &lt;-<span class="st"> </span><span class="kw">apply</span>(df,<span class="dv">2</span>,rank,<span class="dt">ties.method=</span><span class="st">&quot;average&quot;</span>)
  df_sorted &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">apply</span>(df, <span class="dv">2</span>, sort))
  df_mean &lt;-<span class="st"> </span><span class="kw">apply</span>(df_sorted, <span class="dv">1</span>, mean)
   
  index_to_mean &lt;-<span class="st"> </span><span class="cf">function</span>(my_index, my_mean){
    <span class="kw">return</span>(my_mean[my_index])
  }
   
  df_final &lt;-<span class="st"> </span><span class="kw">apply</span>(df_rank, <span class="dv">2</span>, index_to_mean, <span class="dt">my_mean=</span>df_mean) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>()
  <span class="co">#rownames(df_final) &lt;- rownames(df)</span>
  <span class="kw">return</span>(df_final)
}

<span class="co">#dt_con &lt;- dat_tidy %&gt;% select(-c(1:2,6:8))</span>
<span class="co">#dt_trt &lt;- dat_tidy %&gt;% select(-c(1:5))</span>

<span class="co">#dt_con_norm &lt;- quantile_normalisation(dt_con)</span>
<span class="co">#dt_trt_norm &lt;- quantile_normalisation(dt_trt)</span>

dt &lt;-<span class="st"> </span>dat_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">quantile_normalisation</span>()

dat_norm &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(dat_tidy[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>],dt)

<span class="co">#dat_norm &lt;- bind_cols(dat_tidy[,1:2],dt_con_norm,dt_trt_norm)</span>
<span class="co"># Have a look at the median normalised data</span>
<span class="kw">glimpse</span>(dat_norm)</code></pre></div>
<pre><code>## Observations: 1,095
## Variables: 8
## $ protein_accession   &lt;chr&gt; &quot;4562_DHE3_HUMAN&quot;, &quot;14948_RS2_HUMAN&quot;, &quot;143...
## $ protein_description &lt;chr&gt; &quot;Glutamate dehydrogenase 1_ mitochondrial ...
## $ con1                &lt;dbl&gt; 8.7383500, 24.6381167, 0.6251333, 9.166716...
## $ con2                &lt;dbl&gt; 11.8365000, 28.3875333, 0.7185167, 11.9014...
## $ con3                &lt;dbl&gt; 8.666500, 31.284083, 0.646800, 4.532583, 5...
## $ trt1                &lt;dbl&gt; 13.337283, 14.171300, 1.584183, 5.452217, ...
## $ trt2                &lt;dbl&gt; 0.8607500, 14.4218000, 1.0512833, 4.244433...
## $ trt3                &lt;dbl&gt; 9.343483, 13.670950, 2.139083, 4.735550, 6...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat_norm <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(con1))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(con2), <span class="dt">colour =</span> <span class="st">&quot;blue&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(con3), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="kw">log2</span>(trt3), <span class="dt">colour =</span> <span class="st">&quot;green&quot;</span>))</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/tidy-data-3.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Save the median normalised data</span>
<span class="kw">write_excel_csv</span>(dat_norm,<span class="st">&quot;data/example_nomralised_proteomics_data.csv&quot;</span>)</code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Use <code>t.test</code> to perform Welch Two Sample t-test on untransformed data. This outputs the p-values we need for each protein.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># T-test function for multiple experiments</span>
expriments_ttest &lt;-<span class="st"> </span><span class="cf">function</span>(dt,grp1,grp2){
  <span class="co"># Subset control group and convert to numeric</span>
  x &lt;-<span class="st"> </span>dt[grp1] <span class="op">%&gt;%</span><span class="st"> </span>unlist <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()
  <span class="co"># Subset treatment group and convert to numeric</span>
  y &lt;-<span class="st"> </span>dt[grp2] <span class="op">%&gt;%</span><span class="st"> </span>unlist <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.numeric</span>()
  <span class="co"># Perform t-test</span>
  result &lt;-<span class="st"> </span><span class="kw">t.test</span>(x, y)
  <span class="co"># Return p-values</span>
  <span class="kw">return</span>(result<span class="op">$</span>p.value)
}  

<span class="co"># Apply t-test function to data</span>
<span class="co"># array = dat, 1 = rows, FUN = expriments_ttest, and arguements</span>
<span class="co"># For median normalised data</span>
p_vals &lt;-<span class="st"> </span><span class="kw">apply</span>(dat_norm,<span class="dv">1</span>,expriments_ttest, <span class="dt">grp1 =</span> <span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">5</span>), <span class="dt">grp2 =</span> <span class="kw">c</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>))
<span class="co"># For maximum normalised data</span>
p_vals_max &lt;-<span class="st"> </span><span class="kw">apply</span>(dat_norm_max,<span class="dv">1</span>,expriments_ttest, <span class="dt">grp1 =</span> <span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">5</span>), <span class="dt">grp2 =</span> <span class="kw">c</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">8</span>))

<span class="co"># Plot histograms</span>
<span class="kw">hist</span>(p_vals)</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/t-test-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(p_vals_max)</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/t-test-2.png" width="672" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Perform log transformation of the observations for each protein.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select columns and log data</span>
dat_log &lt;-<span class="st"> </span>dat_norm <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(protein_accession,protein_description)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">log2</span>()
dat_max_log &lt;-<span class="st"> </span>dat_norm_max <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(protein_accession,protein_description)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">log2</span>()</code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Calculate the mean observation for each protein under each condition.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">con &lt;-<span class="st"> </span><span class="kw">apply</span>(dat_log[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>],<span class="dv">1</span>,mean)
trt &lt;-<span class="st"> </span><span class="kw">apply</span>(dat_log[,<span class="dv">4</span><span class="op">:</span><span class="dv">6</span>],<span class="dv">1</span>,mean)

con_max &lt;-<span class="st"> </span><span class="kw">apply</span>(dat_max_log[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>],<span class="dv">1</span>,mean)
trt_max &lt;-<span class="st"> </span><span class="kw">apply</span>(dat_max_log[,<span class="dv">4</span><span class="op">:</span><span class="dv">6</span>],<span class="dv">1</span>,mean)</code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>The log fold change is then the difference between condition 1 and condition 2. Plot a histogram to look at the distribution.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate fold change</span>
dat_fc &lt;-<span class="st"> </span>con <span class="op">-</span><span class="st"> </span>trt
dat_max_fc &lt;-<span class="st"> </span>con_max <span class="op">-</span><span class="st"> </span>trt_max

<span class="co"># Plot histograms</span>
<span class="kw">hist</span>(dat_fc)</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/fold-change-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(dat_max_fc)</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/fold-change-2.png" width="672" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Create a combined table of log fold change and p-values for all the proteins for plotting a volcano plot.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">prots=</span> dat_norm<span class="op">$</span>protein_accession,
                      <span class="dt">logfc =</span> dat_fc, 
                      <span class="dt">pval =</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span><span class="kw">log10</span>(p_vals))

dat_max &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">prots=</span> dat_norm_max<span class="op">$</span>protein_accession,
                      <span class="dt">logfc =</span> dat_max_fc, 
                      <span class="dt">pval =</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span><span class="kw">log10</span>(p_vals_max))

dat_max <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(logfc,pval)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/vol-pot-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">threshold =</span> <span class="kw">if_else</span>(logfc <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>pval <span class="op">&gt;=</span><span class="st"> </span><span class="fl">1.5</span> <span class="op">|</span><span class="st"> </span>
<span class="st">                               </span>logfc <span class="op">&lt;=</span><span class="st"> </span><span class="op">-</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>pval <span class="op">&gt;=</span><span class="st"> </span><span class="fl">1.5</span>,<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(logfc,pval, <span class="dt">colour =</span> threshold)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;A&quot;</span>=<span class="st"> &quot;red&quot;</span>, <span class="st">&quot;B&quot;</span>=<span class="st"> &quot;black&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;log2 fold change&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;-log10 p-value&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/vol-pot-2.png" width="672" /></p>
<div id="heatmap-transformation" class="section level2">
<h2><span class="header-section-number">4.1</span> Heatmap transformation</h2>
<ol style="list-style-type: decimal">
<li>Clustering the data</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat_mut &lt;-<span class="st"> </span>dat_norm <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pval =</span> dat<span class="op">$</span>pval, <span class="dt">logfc =</span> dat<span class="op">$</span>logfc) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(pval <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>(logfc <span class="op">&gt;=</span><span class="dv">2</span> <span class="op">|</span><span class="st"> </span>logfc <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">9</span><span class="op">:</span><span class="dv">10</span>))

dat_sel &lt;-<span class="st"> </span><span class="kw">as.matrix.data.frame</span>(dat_mut[,<span class="dv">2</span><span class="op">:</span><span class="dv">7</span>]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">log2</span>()
<span class="kw">row.names</span>(dat_sel) &lt;-<span class="st"> </span>dat_mut<span class="op">$</span>protein_accession

dat.tn &lt;-<span class="st"> </span><span class="kw">scale</span>(<span class="kw">t</span>(dat_sel)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>()
<span class="co">#dat.tn &lt;- t(dat.n)</span>
<span class="co">#dat.tn &lt;- dat_sel</span>

<span class="co">#gplots::heatmap.2(dat.tn, scale = &#39;row&#39;,trace=&quot;none&quot;)</span>
<span class="kw">library</span>(pheatmap)
<span class="kw">pheatmap</span>(dat.tn,<span class="dt">cutree_rows =</span> <span class="dv">2</span>,
         <span class="dt">cutree_cols =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cal_z_score &lt;-<span class="st"> </span><span class="cf">function</span>(x){
  (x <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(x)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(x)
}
 
data_subset_norm &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">apply</span>(dat_mut[,<span class="dv">2</span><span class="op">:</span><span class="dv">7</span>], <span class="dv">1</span>, cal_z_score))
<span class="kw">row.names</span>(data_subset_norm) &lt;-<span class="st"> </span>dat_mut<span class="op">$</span>protein_accession
<span class="kw">pheatmap</span>(data_subset_norm)</code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d1 &lt;-<span class="st"> </span>dat.tn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">dist</span>(.,<span class="dt">method =</span> <span class="st">&quot;euclidean&quot;</span>, <span class="dt">diag =</span> <span class="ot">FALSE</span>, <span class="dt">upper =</span> <span class="ot">FALSE</span>)

d2 &lt;-<span class="st"> </span>dat.tn <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">dist</span>(.,<span class="dt">method =</span> <span class="st">&quot;euclidean&quot;</span>, <span class="dt">diag =</span> <span class="ot">FALSE</span>, <span class="dt">upper =</span> <span class="ot">FALSE</span>)

<span class="co"># Clustering distance between experiments using Ward linkage</span>
c1 &lt;-<span class="st"> </span><span class="kw">hclust</span>(d1, <span class="dt">method =</span> <span class="st">&quot;ward.D2&quot;</span>, <span class="dt">members =</span> <span class="ot">NULL</span>)
<span class="co"># Clustering distance between proteins using Ward linkage</span>
c2 &lt;-<span class="st"> </span><span class="kw">hclust</span>(d2, <span class="dt">method =</span> <span class="st">&quot;ward.D2&quot;</span>, <span class="dt">members =</span> <span class="ot">NULL</span>)

<span class="co"># Check clustering by plotting dendrograms</span>
<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>),<span class="dt">cex=</span><span class="fl">0.5</span>) <span class="co"># Make 2 rows, 1 col plot frame and shrink labels</span>
<span class="kw">plot</span>(c1); <span class="kw">plot</span>(c2) <span class="co"># Plot both cluster dendrograms</span></code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/unnamed-chunk-2-3.png" width="672" /> 2. Plot the data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Set colours for heatmap, 25 increments</span>
my_palette &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;white&quot;</span>,<span class="st">&quot;red&quot;</span>))(<span class="dt">n =</span> <span class="dv">25</span>)

<span class="co"># Plot heatmap with heatmap.2</span>
<span class="kw">par</span>(<span class="dt">cex.main=</span><span class="fl">0.75</span>) <span class="co"># Shrink title fonts on plot</span>
gplots<span class="op">::</span><span class="kw">heatmap.2</span>(dat.tn,                     <span class="co"># Tidy, normalised data</span>
          <span class="dt">Colv=</span><span class="kw">as.dendrogram</span>(c1),     <span class="co"># Experiments clusters in cols</span>
          <span class="dt">Rowv=</span><span class="kw">as.dendrogram</span>(c2),     <span class="co"># Protein clusters in rows</span>
          <span class="dt">density.info=</span><span class="st">&quot;histogram&quot;</span>,   <span class="co"># Plot histogram of data and colour key</span>
          <span class="dt">trace=</span><span class="st">&quot;none&quot;</span>,               <span class="co"># Turn of trace lines from heat map</span>
          <span class="dt">col =</span> my_palette,           <span class="co"># Use my colour scheme</span>
          <span class="dt">cexRow=</span><span class="fl">0.5</span>,<span class="dt">cexCol=</span><span class="fl">0.75</span>)     <span class="co"># Amend row and column label fonts</span></code></pre></div>
<p><img src="bspr-workshop-2018_files/figure-html/heatmap-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="transform.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="visualising-proteomics-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["bspr-workshop-2018.pdf", "bspr-workshop-2018.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
